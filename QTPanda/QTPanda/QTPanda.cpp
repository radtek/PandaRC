#include "QTPanda.h"
#include "Common/NamedPipe.h"
#include "Common/NetAPI.h"
#include "Decoder/websocket.h"
#include "DllInject.h"
#include <QFile.h>
#include <QTextStream.h>

NamedPipeServer goPipeServer;
LPCSTR lpszProcessName = "MEmuHeadless.exe";
LPCSTR lpszDllName = "E:\\PandaRC\\QTPanda\\Debug\\HACK.dll";

std::string ToHex(uint8_t* data, int len)
{
	char sTmpBuf[8];
	std::string strHex;
	for (int i = 0; i < len; i++)
	{
		sprintf(sTmpBuf, "%02X ", data[i]);
		strHex += sTmpBuf;
	}
	return strHex;
}

void QTPanda::closeEvent(QCloseEvent *event)
{
	unjectDll(lpszProcessName, lpszDllName);
	m_bShutDown = true;
	m_oWorderThread.Join();
}

void QTPanda::injectDll(LPCSTR lpszProcessName, LPCSTR lpszDllName)
{
	::InjectDll(lpszProcessName, lpszDllName);
}

void QTPanda::unjectDll(LPCSTR lpszProcessName, LPCSTR lpszDllName)
{
	DWORD dwProcessID = FindProcess(lpszProcessName);
	NSPROTO::SRV_EXITTHREAD exit;
	goPipeServer.SendMsg2Client(dwProcessID, &exit);
	::UnjectDll(lpszProcessName, lpszDllName);
}

void QTPanda::WorkderFunc(void* param)
{
	char sIPHost[128] = { 0 };
	char sIPPeer[128] = { 0 };
	char sHeader[1024] = { 0 };
	QTPanda* pParent = (QTPanda*)param;
	MailBox<NSPROTO::COM_DATA>& oMailBox = goPipeServer.GetMailBox();

	QFile ofile("./ouput.txt");
	ofile.remove();
	while (!pParent->m_bShutDown)
	{
		NSPROTO::COM_DATA data;
		bool bRet = oMailBox.Recv(&data, 100);
		if (!bRet)
			continue;
		if (strstr(data.data, "HTTP"))
			continue;

		NetAPI::N2P(data.hostip, sIPHost, sizeof(sIPHost));
		NetAPI::N2P(data.peerip, sIPPeer, sizeof(sIPPeer));
		sprintf(sHeader, "\n%s host=%s:%d peer=%s:%d len=%d data=", data.sparam1, sIPHost, data.hostport, sIPPeer, data.peerport, data.len);
		std::string output = sHeader;
		std::string hex = ToHex((uint8_t*)data.data, data.len);
		output += hex;
		std::string raw(data.data, data.len);
		output += "\nraw=" + raw;
		
		if (ofile.open(QIODevice::Append | QIODevice::WriteOnly))
		{
			QDataStream stream(&ofile);
			stream.writeBytes(output.c_str(), output.size());
			ofile.close();
		}
		OutputDebugString(output.c_str());
	}
}

QTPanda::QTPanda(QWidget *parent)
	: QMainWindow(parent)
{
	ui.setupUi(this);
	m_bShutDown = false;
	goPipeServer.Init((HWND)winId());
	m_oWorderThread.Create(&QTPanda::WorkderFunc, this);
} 

void QTPanda::onBtnSendMsg()
{
	uint8_t data[] = {0x82,0x93,0x94,0x8F,0x45,0xC0,0x94,0xCF,0xA7,0xC1,0x94,0x8C,0x45,0xC5,0x96,0x8F,0x45,0xC0,0x94,0x87,0xA0,0x3A,0x9A,0x9F,0x45};
	uint8_t data2[] = {0x82,0x7E,0x07,0x6D,0x00,0x40,0xE2,0x01,0x00,0x03,0x00,0x05,0x02,0x00,0x00,0x00,0x00,0x08,0x00,0x1A,0x22,0x08,0xA5,0x04,0x12,0x08,0x33,0x30,0x35,0x32,0x35,0x39,0x32,0x36,0x18,0x10,0x20,0x09,0x29,0xD4,0x12,0xF2,0x81,0x17,0xFC,0x20,0x41,0x30,0x06,0x38,0x00,0x40,0xBA,0xEE,0x05,0x1A,0x22,0x08,0xA6,0x04,0x12,0x08,0x31,0x36,0x37,0x38,0x37,0x37,0x34,0x34,0x18,0x13,0x20,0x04,0x29,0xF0,0xC9,0xC3,0xC2,0xCE,0xAA,0x20,0x41,0x30,0x06,0x38,0x00,0x40,0xB9,0x87,0x07,0x1A,0x22,0x08,0xA2,0x04,0x12,0x08,0x38,0x31,0x32,0x39,0x36,0x36,0x39,0x39,0x18,0x13,0x20,0x08,0x29,0xF1,0x41,0xCF,0x86,0x37,0x72,0x20,0x41,0x30,0x06,0x38,0x00,0x40,0xD9,0xC9,0x06,0x1A,0x22,0x08,0xA0,0x04,0x12,0x08,0x35,0x34,0x37,0x38,0x30,0x32,0x30,0x31,0x18,0x0A,0x20,0x01,0x29,0x65,0xF7,0xE4,0xE1,0xE1,0x34,0x20,0x41,0x30,0x06,0x38,0x00,0x40,0xBC,0x89,0x06,0x1A,0x23,0x08,0xAD,0x04,0x12,0x09,0x32,0x36,0x33,0x33,0x32,0x34,0x36,0x33,0x09,0x18,0x11,0x20,0x06,0x29,0x10,0x95,0xD4,0x09,0xAD,0xFF,0x1F,0x41,0x30,0x05,0x38,0x00,0x40,0xF1,0xCD,0x05,0x1A,0x22,0x08,0xAC,0x04,0x12,0x08,0x33,0x32,0x35,0x37,0x37,0x30,0x30,0x37,0x18,0x0F,0x20,0x06,0x29,0x5B,0x29,0xCB,0x90,0xBB,0x9C,0x1F,0x41,0x30,0x05,0x38,0x00,0x40,0x82,0x94,0x07,0x1A,0x22,0x08,0x99,0x04,0x12,0x08,0x34,0x38,0x38,0x32,0x35,0x34,0x39,0x37,0x18,0x09,0x20,0x0A,0x29,0xE9,0x36,0x1A,0xC0,0xE3,0x89,0x1F,0x41,0x30,0x06,0x38,0x00,0x40,0xFA,0xA5,0x06,0x1A,0x22,0x08,0x9F,0x04,0x12,0x08,0x35,0x30,0x35,0x33,0x30,0x38,0x34,0x33,0x18,0x08,0x20,0x0B,0x29,0x1C,0xEB,0xE2,0x36,0x5C,0x07,0x1F,0x41,0x30,0x06,0x38,0x00,0x40,0xD4,0xC6,0x06,0x1A,0x22,0x08,0xA7,0x04,0x12,0x08,0x35,0x33,0x30,0x30,0x35,0x31,0x39,0x38,0x18,0x04,0x20,0x01,0x29,0x91,0x97,0x6E,0xD2,0xAA,0xE8,0x1E,0x41,0x30,0x06,0x38,0x00,0x40,0xBA,0x9A,0x07,0x1A,0x22,0x08,0xA3,0x04,0x12,0x08,0x36,0x38,0x31,0x34,0x36,0x39,0x37,0x32,0x18,0x0A,0x20,0x01,0x29,0x48,0x59,0x86,0x78,0x5C,0x6A,0x1E,0x41,0x30,0x06,0x38,0x00,0x40,0x97,0x9A,0x07,0x1A,0x22,0x08,0xA1,0x04,0x12,0x08,0x37,0x38,0x39,0x38,0x36,0x34,0x30,0x39,0x18,0x05,0x20,0x03,0x29,0x03,0x81,0x95,0x43,0xE4,0x51,0x1E,0x41,0x30,0x06,0x38,0x00,0x40,0xDC,0xF7,0x06,0x1A,0x22,0x08,0xA9,0x04,0x12,0x08,0x31,0x34,0x30,0x35,0x32,0x31,0x31,0x36,0x18,0x10,0x20,0x07,0x29,0xA2,0xC6,0x4B,0xF7,0x8B,0x40,0x1E,0x41,0x30,0x06,0x38,0x00,0x40,0x8E,0xAD,0x06,0x1A,0x22,0x08,0x95,0x04,0x12,0x08,0x35,0x33,0x39,0x36,0x31,0x35,0x38,0x39,0x18,0x02,0x20,0x0A,0x29,0x53,0xF3,0x8E,0x13,0xC6,0x2D,0x1E,0x41,0x30,0x06,0x38,0x00,0x40,0xBC,0xF0,0x05,0x1A,0x22,0x08,0x9E,0x04,0x12,0x08,0x31,0x33,0x39,0x38,0x34,0x35,0x38,0x34,0x18,0x07,0x20,0x03,0x29,0xFE,0xBB,0x05,0xD2,0xFC,0x78,0x1D,0x41,0x30,0x06,0x38,0x00,0x40,0xB2,0xFD,0x05,0x1A,0x22,0x08,0x9C,0x04,0x12,0x08,0x31,0x33,0x34,0x36,0x33,0x35,0x31,0x31,0x18,0x04,0x20,0x09,0x29,0x11,0x83,0xC0,0xCA,0xDB,0x3F,0x1C,0x41,0x30,0x06,0x38,0x00,0x40,0xF9,0x93,0x07,0x1A,0x23,0x08,0x9D,0x0B,0x12,0x09,0xE5,0xA4,0x8F,0xE9,0x99,0x8C,0xE4,0xBB,0x9F,0x18,0x13,0x20,0x06,0x29,0x00,0x00,0x00,0x00,0xAC,0xEB,0x14,0x41,0x30,0x07,0x38,0x01,0x40,0xDC,0x80,0x01,0x1A,0x22,0x08,0xB1,0x06,0x12,0x08,0x39,0x39,0x36,0x39,0x31,0x34,0x37,0x34,0x18,0x07,0x20,0x03,0x29,0x00,0x00,0x00,0x00,0x2C,0x88,0x14,0x41,0x30,0x06,0x38,0x00,0x40,0xE8,0xF1,0x06,0x1A,0x22,0x08,0xB3,0x06,0x12,0x08,0x36,0x32,0x33,0x32,0x30,0x35,0x33,0x33,0x18,0x01,0x20,0x0B,0x29,0x00,0x00,0x00,0x00,0x3C,0x36,0x14,0x41,0x30,0x06,0x38,0x00,0x40,0xB5,0xBD,0x06,0x1A,0x29,0x08,0xFC,0x0A,0x12,0x0F,0xE5,0xA4,0xA7,0xE7,0x9C,0xBC,0xE8,0x90,0x8C,0xE5,0x98,0x9F,0xE5,0xAE,0x9D,0x18,0x08,0x20,0x0B,0x29,0x00,0x00,0x00,0x00,0x74,0x0F,0x14,0x41,0x30,0x07,0x38,0x00,0x40,0xB8,0xBB,0x04,0x1A,0x22,0x08,0xA8,0x06,0x12,0x08,0x37,0x34,0x30,0x37,0x34,0x36,0x36,0x30,0x18,0x0B,0x20,0x09,0x29,0x00,0x00,0x00,0x00,0xD2,0xF9,0x13,0x41,0x30,0x06,0x38,0x00,0x40,0x8B,0xA2,0x07,0x1A,0x32,0x08,0x87,0x0B,0x12,0x18,0xE7,0x9F,0xAD,0xE7,0x9F,0xAD,0xE4,0xB8,0x80,0xE7,0x94,0x9F,0xE5,0xA4,0xAA,0xE5,0xA4,0x9A,0xE5,0x8F,0x98,0xE5,0x8C,0x96,0x18,0x07,0x20,0x0A,0x29,0x00,0x00,0x00,0x00,0x18,0xA5,0x13,0x41,0x30,0x07,0x38,0x00,0x40,0xAA,0xDA,0x04,0x1A,0x22,0x08,0xA3,0x06,0x12,0x08,0x39,0x38,0x39,0x34,0x35,0x30,0x39,0x32,0x18,0x11,0x20,0x0C,0x29,0x00,0x00,0x00,0x00,0xFA,0x8B,0x13,0x41,0x30,0x05,0x38,0x00,0x40,0xDE,0x98,0x06,0x1A,0x22,0x08,0xAE,0x06,0x12,0x08,0x32,0x38,0x31,0x34,0x32,0x38,0x30,0x32,0x18,0x0F,0x20,0x0B,0x29,0x00,0x00,0x00,0x00,0x6A,0x88,0x13,0x41,0x30,0x06,0x38,0x00,0x40,0xA5,0xE4,0x06,0x1A,0x22,0x08,0xB6,0x06,0x12,0x08,0x32,0x30,0x37,0x39,0x35,0x33,0x32,0x37,0x18,0x0A,0x20,0x0C,0x29,0x00,0x00,0x00,0x00,0xB8,0x66,0x13,0x41,0x30,0x06,0x38,0x00,0x40,0x92,0xA7,0x06,0x1A,0x22,0x08,0xAC,0x06,0x12,0x08,0x34,0x38,0x32,0x39,0x31,0x39,0x30,0x37,0x18,0x02,0x20,0x03,0x29,0x00,0x00,0x00,0x00,0xCA,0x18,0x13,0x41,0x30,0x06,0x38,0x00,0x40,0xF6,0xFC,0x05,0x1A,0x22,0x08,0xB9,0x06,0x12,0x08,0x37,0x33,0x32,0x31,0x35,0x32,0x34,0x31,0x18,0x02,0x20,0x06,0x29,0x00,0x00,0x00,0x00,0xD8,0x0E,0x13,0x41,0x30,0x06,0x38,0x00,0x40,0x9A,0xA3,0x07,0x1A,0x20,0x08,0x96,0x0B,0x12,0x06,0xE7,0xBB,0x9D,0xE6,0x81,0x8B,0x18,0x04,0x20,0x0A,0x29,0x00,0x00,0x00,0x00,0xF4,0x0A,0x13,0x41,0x30,0x07,0x38,0x00,0x40,0xFD,0xDC,0x04,0x1A,0x22,0x08,0xA7,0x06,0x12,0x08,0x33,0x30,0x34,0x32,0x31,0x33,0x39,0x30,0x18,0x08,0x20,0x04,0x29,0x00,0x00,0x00,0x00,0xA0,0xC4,0x12,0x41,0x30,0x03,0x38,0x00,0x40,0xDF,0xA9,0x06,0x1A,0x22,0x08,0xB4,0x06,0x12,0x08,0x34,0x36,0x38,0x31,0x33,0x35,0x38,0x33,0x18,0x13,0x20,0x01,0x29,0x00,0x00,0x00,0x00,0xC8,0xB5,0x12,0x41,0x30,0x06,0x38,0x00,0x40,0x9F,0xF8,0x06,0x1A,0x29,0x08,0x98,0x0B,0x12,0x0F,0xE6,0x94,0xB6,0xE6,0x95,0x9B,0xE9,0x82,0xA3,0xE4,0xBB,0xBD,0xE7,0x88,0xB1,0x18,0x06,0x20,0x07,0x29,0x00,0x00,0x00,0x00,0x56,0xA4,0x12,0x41,0x30,0x07,0x38,0x01,0x40,0xCE,0x92,0x01,0x1A,0x22,0x08,0xB5,0x06,0x12,0x08,0x31,0x33,0x36,0x39,0x37,0x30,0x35,0x31,0x18,0x05,0x20,0x0A,0x29,0x00,0x00,0x00,0x00,0xBE,0x7B,0x12,0x41,0x30,0x06,0x38,0x00,0x40,0xEB,0x86,0x07,0x1A,0x22,0x08,0xB0,0x06,0x12,0x08,0x32,0x38,0x31,0x38,0x39,0x36,0x32,0x38,0x18,0x0D,0x20,0x05,0x29,0x00,0x00,0x00,0x00,0xF4,0x75,0x12,0x41,0x30,0x06,0x38,0x00,0x40,0x8D,0xAB,0x07,0x1A,0x22,0x08,0xBC,0x06,0x12,0x08,0x39,0x34,0x34,0x38,0x34,0x33,0x31,0x38,0x18,0x0A,0x20,0x03,0x29,0x00,0x00,0x00,0x00,0xAC,0x44,0x12,0x41,0x30,0x06,0x38,0x00,0x40,0xDA,0xA4,0x07,0x1A,0x22,0x08,0xA6,0x06,0x12,0x08,0x33,0x35,0x37,0x34,0x38,0x36,0x38,0x33,0x18,0x0A,0x20,0x08,0x29,0x00,0x00,0x00,0x00,0x04,0x24,0x12,0x41,0x30,0x06,0x38,0x00,0x40,0x8D,0xC7,0x06,0x1A,0x22,0x08,0xAA,0x06,0x12,0x08,0x32,0x37,0x30,0x31,0x35,0x32,0x39,0x37,0x18,0x06,0x20,0x0C,0x29,0x00,0x00,0x00,0x00,0x76,0xD8,0x11,0x41,0x30,0x06,0x38,0x00,0x40,0xD9,0xE9,0x06,0x1A,0x2F,0x08,0x89,0x0B,0x12,0x15,0xE7,0xAC,0x91,0xE7,0x9C,0x8B,0xE4,0xB8,0x96,0xE9,0x97,0xB4,0xE5,0x87,0xA0,0xE5,0xA4,0x9A,0xE6,0x84,0x81,0x18,0x12,0x20,0x09,0x29,0x00,0x00,0x00,0x00,0xCC,0xA9,0x11,0x41,0x30,0x07,0x38,0x00,0x40,0x82,0xA7,0x04,0x1A,0x22,0x08,0xE2,0x08,0x12,0x08,0x32,0x30,0x33,0x33,0x34,0x34,0x30,0x35,0x18,0x07,0x20,0x0B,0x29,0xD2,0xCC,0xCC,0xCC,0x5C,0x83,0x11,0x41,0x30,0x04,0x38,0x00,0x40,0xF4,0x82,0x06,0x1A,0x2E,0x08,0x9E,0x0B,0x12,0x15,0xE6,0xA2,0xA6,0xE9,0x87,0x8C,0xE8,0xB5,0xA2,0xE9,0x92,0xB1,0xE7,0x9C,0x9F,0xE4,0xB8,0x8D,0xE7,0x88,0xBD,0x18,0x03,0x20,0x06,0x29,0x00,0x00,0x00,0x00,0x2E,0x7B,0x11,0x41,0x30,0x07,0x38,0x01,0x40,0xEA,0x7F,0x1A,0x26,0x08,0x97,0x0B,0x12,0x0C,0xE4,0xBA,0xBA,0xE5,0xBF,0x83,0xE8,0x8B,0xA5,0xE6,0xB5,0xB7,0x18,0x0D,0x20,0x0B,0x29,0x00,0x00,0x00,0x00,0x64,0x77,0x11,0x41,0x30,0x07,0x38,0x01,0x40,0x9E,0x8A,0x01,0x1A,0x22,0x08,0xDE,0x08,0x12,0x08,0x36,0x34,0x35,0x37,0x30,0x32,0x39,0x37,0x18,0x10,0x20,0x04,0x29,0x08,0x00,0x00,0x00,0x36,0x74,0x11,0x41,0x30,0x05,0x38,0x00,0x40,0xF9,0xEF,0x05,0x1A,0x28,0x08,0xA1,0x0B,0x12,0x0F,0xE7,0xBB,0x99,0xE6,0x88,0x91,0xE6,0x8A,0xB1,0xE4,0xB8,0x80,0xE4,0xB8,0xAA,0x18,0x01,0x20,0x0B,0x29,0x00,0x00,0x00,0x00,0x76,0x70,0x11,0x41,0x30,0x07,0x38,0x01,0x40,0x9A,0x72,0x1A,0x28,0x08,0xA3,0x0B,0x12,0x0F,0xE7,0x9C,0x8B,0xE7,0xA9,0xBA,0xE7,0x99,0xBD,0xE8,0xAE,0xB0,0xE5,0xBF,0x86,0x18,0x12,0x20,0x06,0x29,0x00,0x00,0x00,0x00,0x7A,0x1C,0x11,0x41,0x30,0x07,0x38,0x01,0x40,0xBD,0x77,0x1A,0x22,0x08,0xE5,0x08,0x12,0x08,0x33,0x31,0x33,0x31,0x33,0x36,0x39,0x38,0x18,0x0A,0x20,0x08,0x29,0x6B,0x66,0x66,0x66,0xED,0xFE,0x10,0x41,0x30,0x07,0x38,0x00,0x40,0x97,0x95,0x06,0x1A,0x22,0x08,0xE4,0x08,0x12,0x08,0x35,0x34,0x37,0x33,0x39,0x35,0x37,0x37,0x18,0x0E,0x20,0x05,0x29,0x6D,0x66,0x66,0x66,0x9C,0xDE,0x10,0x41,0x30,0x05,0x38,0x00,0x40,0x95,0x9C,0x06,0x1A,0x22,0x08,0xD8,0x08,0x12,0x08,0x33,0x31,0x36,0x37,0x39,0x37,0x31,0x30,0x18,0x12,0x20,0x01,0x29,0x3C,0x33,0x33,0x33,0x9C,0xD9,0x10,0x41,0x30,0x07,0x38,0x00,0x40,0xCC,0xE9,0x05,0x1A,0x28,0x08,0x9C,0x0B,0x12,0x0F,0xE5,0x8A,0xA0,0xE5,0x8B,0x92,0xE6,0xAF,0x94,0xE5,0xA5,0xB6,0xE9,0x85,0xAA,0x18,0x0E,0x20,0x04,0x29,0x00,0x00,0x00,0x00,0xCC,0xC6,0x10,0x41,0x30,0x07,0x38,0x01,0x40,0xEB,0x7B,0x1A,0x2B,0x08,0xA4,0x0B,0x12,0x12,0xE6,0x83,0xB3,0xE4,0xBD,0xA0,0xE5,0x83,0x8F,0xE6,0x97,0xA0,0xE5,0xBD,0xB1,0xE4,0xBA,0xBA,0x18,0x06,0x20,0x01,0x29,0x00,0x00,0x00,0x00,0x1A,0xA5,0x10,0x41,0x30,0x07,0x38,0x01,0x40,0xC9,0x75,0x1A,0x22,0x08,0xDD,0x08,0x12,0x08,0x39,0x32,0x38,0x33,0x32,0x36,0x33,0x30,0x18,0x06,0x20,0x05,0x29,0x36,0x33,0x33,0x33,0xB0,0x7E,0x10,0x41,0x30,0x07,0x38,0x00,0x40,0x8C,0xA4,0x06,0x1A,0x22,0x08,0xDC,0x08,0x12,0x08,0x36,0x37,0x32,0x31,0x38,0x32,0x36,0x30,0x18,0x10,0x20,0x0C,0x29,0x35,0x33,0x33,0x33,0x64,0x2A,0x10,0x41,0x30,0x05,0x38,0x00,0x40,0x90,0x89,0x06,0x1A,0x22,0x08,0xD0,0x08,0x12,0x08,0x32,0x39,0x31,0x37,0x33,0x33,0x35,0x35,0x18,0x01,0x20,0x08,0x29,0x6E,0x66,0x66,0x66,0x8D,0x18,0x10,0x41,0x30,0x06,0x38,0x00,0x40,0xAE,0x82,0x06};
	uint8_t decode[sizeof(data2)] = { 0 };
	int dlen = 0;
	NSWSD::DecodePacket(data2, sizeof(data2), 0, decode, dlen);
	//OutputDebugString((char*)data);
	//OutputDebugString("\n");
	OutputDebugString((char*)decode);
}

void QTPanda::onBtnInject()
{
	injectDll(lpszProcessName, lpszDllName);
}

void QTPanda::onBtnUnject()
{
	unjectDll(lpszProcessName, lpszDllName);
}
